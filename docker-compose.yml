services:

  # --- GRUPO 1: WEB & PORTFOLIO (Red Pública Protegida) ---

  backend-portfolio:
    image: ez-backend:v1
    container_name: backend-portfolio
    restart: unless-stopped
    networks:
      - web-net
    environment:
      - TZ=${TIMEZONE}

  frontend-portfolio:
    image: ez-portfolio:v4
    container_name: frontend-portfolio
    restart: unless-stopped
    depends_on:
      - backend-portfolio
    networks:
      - web-net
    environment:
      - TZ=${TIMEZONE}

  # --- GRUPO 2: MEDIA & AUTOMATION (Red Privada) ---

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    volumes:
      - ./homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - HOMEPAGE_ALLOWED_HOSTS=*
    restart: unless-stopped
    networks:
      - media-net  # Ve a los servicios multimedia
      - web-net    # Ve al backend/frontend para mostrar stats

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./jellyfin/config:/config
      - /mnt/datos/media:/data/media
    devices:
      - /dev/dri:/dev/dri
    ports:
      - 8096:8096
    restart: unless-stopped
    networks:
      - media-net

  samba:
    image: dperson/samba
    container_name: samba
    environment:
      - TZ=${TIMEZONE}
      - WORKGROUP=WORKGROUP
      - USER=${SAMBA_USER};${SAMBA_PASS}
      - PERMISSIONS=true
    volumes:
      - /mnt/datos/media:/mount/media
    ports:
      - "139:139"
      - "445:445"
    restart: unless-stopped
    command: '-s "Media;/mount/media;yes;no;no;ez;none;none;Media Share" -p'
    networks:
      - media-net

  # --- SERVICIOS DE RED Y DNS ---

  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: ez-lab
    environment:
      - TS_AUTHKEY=${TAILSCALE_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=--advertise-exit-node
    volumes:
      - ./tailscale/state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: unless-stopped
    network_mode: host # Tailscale prefiere 'host' para manejar mejor la VPN

  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    environment:
      - TZ=${TIMEZONE}
      - WEBPASSWORD=${PIHOLE_PASS}
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8080:80/tcp"
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    networks:
      - media-net
      - web-net # Para servir DNS a todos

  # --- DOWNLOADERS (Arr Stack) ---
  # Todos van a media-net para hablar entre ellos

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
      - WEBUI_PORT=8090
    volumes:
      - ./qbittorrent/config:/config
      - /mnt/datos/torrents:/data
    ports:
      - 8090:8090
      - 6881:6881
      - 6881:6881/udp
    restart: unless-stopped
    networks:
      - media-net

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./prowlarr/config:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    networks:
      - media-net

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./radarr/config:/config
      - /mnt/datos:/data
    ports:
      - 7878:7878
    restart: unless-stopped
    networks:
      - media-net

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./sonarr/config:/config
      - /mnt/datos:/data
    ports:
      - 8989:8989
    restart: unless-stopped
    networks:
      - media-net

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./bazarr/config:/config
      - /mnt/datos:/data
    ports:
      - 6767:6767
    restart: unless-stopped
    networks:
      - media-net

  # ☁️ CLOUDFLARE TUNNEL (El Nexo)
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}
    networks:
      - web-net    # Para ver al Portfolio/Backend
      - media-net  # Para ver a Jellyfin/Arr 

# DEFINICIÓN DE REDES
networks:
  web-net:
    driver: bridge
  media-net:
    driver: bridge